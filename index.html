<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lush NDVI Map Simulation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors (optional, but good practice) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'map-bg': '#0f172a', // Dark blue background
                        'lush-green': {
                            100: '#d1fae5',
                            300: '#6ee7b7',
                            500: '#10b981',
                            700: '#047857',
                            900: '#064e3b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Add Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-map-bg min-h-screen p-4 sm:p-8 flex items-center justify-center font-sans">

    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border border-gray-100">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">
                Regional Vegetation Analysis
            </h1>
            <p class="text-xl text-lush-green-700 font-semibold italic">
                NDVI never looked so lush.
            </p>
        </header>

        <!-- Map Controls and Info -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <button id="regenerate-button"
                class="px-4 py-2 bg-lush-green-700 text-white font-bold rounded-lg shadow-md hover:bg-lush-green-900 transition duration-150 transform hover:scale-105 active:scale-95">
                Regenerate Map
            </button>
            <div class="flex items-center space-x-2 text-sm text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-lush-green-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 102 0V8a1 1 0 10-2 0v2z" clip-rule="evenodd" />
                </svg>
                <span class="font-medium">Hover to see simulated NDVI Score (0.00 - 1.00)</span>
            </div>
        </div>

        <!-- The Map Grid Container -->
        <div id="map-container" class="relative">
            <!-- The map will be rendered here -->
            <div id="ndvi-map" class="grid w-full aspect-square border-4 border-lush-green-700 rounded-xl overflow-hidden shadow-inner bg-gray-200">
                <!-- Grid cells will be injected here -->
            </div>
            <!-- Tooltip for hover information -->
            <div id="tooltip" class="absolute z-10 hidden px-3 py-1 text-xs font-semibold text-white bg-gray-800 rounded-md shadow-lg pointer-events-none transition-opacity duration-150" style="min-width: 100px;"></div>
        </div>

        <!-- Legend -->
        <div class="mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-3">NDVI Color Legend</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full bg-yellow-600 mr-2 border border-gray-300"></div>
                    <span class="text-sm text-gray-700 font-medium">0.00 - 0.20 (Sparse/Water)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full bg-lush-green-300 mr-2 border border-gray-300"></div>
                    <span class="text-sm text-gray-700 font-medium">0.20 - 0.40 (Shrubland)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full bg-lush-green-700 mr-2 border border-gray-300"></div>
                    <span class="text-sm text-gray-700 font-medium">0.40 - 0.60 (Grassland)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full bg-lush-green-900 mr-2 border border-gray-300"></div>
                    <span class="text-sm text-gray-700 font-medium">0.60 - 1.00 (Lush Forest)</span>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase initialization variables (MANDATORY, even if not used)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Define map constants
        const GRID_SIZE = 20;
        const MAP_ELEMENT = document.getElementById('ndvi-map');
        const TOOLTIP_ELEMENT = document.getElementById('tooltip');

        /**
         * Initializes Firebase (Required boilerplate for the platform).
         * Not strictly needed for this front-end simulation but included for compliance.
         */
        async function initializeFirebase() {
            try {
                // We only need a placeholder for the required imports
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { getFirestore } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const { setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`Firebase Initialized for user: ${userId}`);

            } catch (error) {
                console.error("Error initializing Firebase (Ignoring since it's a static visualization):", error);
            }
        }

        /**
         * Maps a simulated NDVI score (0.0 to 1.0) to a Tailwind CSS color class.
         * @param {number} ndvi - The simulated NDVI value.
         * @returns {string} Tailwind CSS class for background color.
         */
        function ndviToColorClass(ndvi) {
            if (ndvi >= 0.60) return 'bg-lush-green-900'; // Deep Forest
            if (ndvi >= 0.40) return 'bg-lush-green-700'; // Lush Grassland
            if (ndvi >= 0.20) return 'bg-lush-green-300'; // Shrubland
            // Using a warmer color for sparse/non-vegetated areas
            if (ndvi >= 0.10) return 'bg-yellow-600'; // Sparse
            return 'bg-blue-300'; // Water / Very low
        }

        /**
         * Generates a realistic-looking, clustered NDVI score for a tile.
         * It averages a base random value with the scores of its neighbors (if they exist)
         * to create spatial correlation, making patterns look organic.
         * @param {number} row - The row index.
         * @param {number} col - The column index.
         * @param {number[][]} mapData - The current map data array.
         * @returns {number} The simulated NDVI score.
         */
        function generateClusteredNDVI(row, col, mapData) {
            let baseNDVI = Math.random();
            let neighborCount = 0;
            let neighborSum = 0;

            // Check Top neighbor
            if (row > 0) {
                neighborSum += mapData[row - 1][col];
                neighborCount++;
            }
            // Check Left neighbor
            if (col > 0) {
                neighborSum += mapData[row][col - 1];
                neighborCount++;
            }

            let clusteredNDVI = baseNDVI;
            if (neighborCount > 0) {
                // Blend the base random value with the average of its immediate neighbors
                // The factor (0.4) controls how much neighboring values influence the current cell
                clusteredNDVI = (baseNDVI * 0.6) + ((neighborSum / neighborCount) * 0.4);
            }

            // Ensure the value is clamped between 0 and 1
            return Math.min(1.0, Math.max(0.0, clusteredNDVI));
        }

        /**
         * Renders the NDVI map visualization.
         */
        function renderNDVIMap() {
            MAP_ELEMENT.innerHTML = '';
            MAP_ELEMENT.style.gridTemplateColumns = `repeat(${GRID_SIZE}, minmax(0, 1fr))`;

            // 1. Initialize the 2D array for map data
            const mapData = Array.from({ length: GRID_SIZE }, () => Array(GRID_SIZE).fill(0));

            const fragment = document.createDocumentFragment();

            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    // 2. Calculate the clustered NDVI score
                    const ndvi = generateClusteredNDVI(row, col, mapData);
                    mapData[row][col] = ndvi;

                    // 3. Create the grid tile element
                    const tile = document.createElement('div');
                    const colorClass = ndviToColorClass(ndvi);

                    tile.className = `aspect-square transition-colors duration-200 ${colorClass}`;
                    tile.dataset.ndvi = ndvi.toFixed(4);

                    // 4. Add interaction listeners
                    tile.addEventListener('mousemove', (e) => {
                        const ndviValue = tile.dataset.ndvi;
                        TOOLTIP_ELEMENT.textContent = `NDVI: ${ndviValue}`;
                        TOOLTIP_ELEMENT.style.left = `${e.clientX + 15}px`;
                        TOOLTIP_ELEMENT.style.top = `${e.clientY - 25}px`;
                        TOOLTIP_ELEMENT.classList.remove('hidden');
                    });

                    tile.addEventListener('mouseleave', () => {
                        TOOLTIP_ELEMENT.classList.add('hidden');
                    });

                    fragment.appendChild(tile);
                }
            }

            MAP_ELEMENT.appendChild(fragment);
        }

        // --- Event Listeners and Initial Load ---

        document.getElementById('regenerate-button').addEventListener('click', () => {
            renderNDVIMap();
        });

        // Initialize on window load
        window.onload = function() {
            initializeFirebase();
            renderNDVIMap(); // Generate the initial map
        };

    </script>
</body>
</html>
